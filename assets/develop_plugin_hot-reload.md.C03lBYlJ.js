import{_ as g,C as n,o as d,c as u,j as a,a as i,E as e,w as t,b as h,ar as r,aD as p}from"./chunks/framework.BeKdlGsR.js";const P=JSON.parse('{"title":"热重载开发","description":"","frontmatter":{},"headers":[],"relativePath":"develop/plugin/hot-reload.md","filePath":"develop/plugin/hot-reload.md","lastUpdated":1770555617000}'),E={name:"develop/plugin/hot-reload.md"},b={class:"tip custom-block"},C={tabindex:"0"},A={class:"tip custom-block"};function F(y,s,B,m,f,v){const c=n("NolebasePageProperties"),l=n("VPNolebaseInlineLinkPreview"),o=n("Mermaid"),k=n("NolebaseGitChangelog");return d(),u("div",null,[s[19]||(s[19]=a("h1",{id:"热重载开发",tabindex:"-1"},[i("热重载开发 "),a("a",{class:"header-anchor",href:"#热重载开发","aria-label":'Permalink to "热重载开发"'},"​")],-1)),e(c),s[20]||(s[20]=a("p",null,[i("在传统的插件开发流程中，每次修改代码都需要手动构建、复制文件、重启 NapCat，效率较低。NapCat 提供了 "),a("strong",null,"热重载（HMR）"),i(" 机制，允许你在开发过程中修改代码后自动重新加载插件，无需重启 NapCat。")],-1)),a("div",b,[s[5]||(s[5]=a("p",{class:"custom-block-title"},"适用场景",-1)),a("p",null,[s[1]||(s[1]=i("热重载适用于 ",-1)),s[2]||(s[2]=a("strong",null,"本地开发和调试阶段",-1)),s[3]||(s[3]=i("。当你完成开发并准备发布时，仍然使用 ",-1)),e(l,{href:"./publish"},{default:t(()=>[...s[0]||(s[0]=[i("发布插件",-1)])]),_:1}),s[4]||(s[4]=i(" 中的标准流程。",-1))])]),s[21]||(s[21]=a("h2",{id:"架构概览",tabindex:"-1"},[i("架构概览 "),a("a",{class:"header-anchor",href:"#架构概览","aria-label":'Permalink to "架构概览"'},"​")],-1)),s[22]||(s[22]=a("p",null,"热重载机制由三个组件协同工作：",-1)),(d(),h(r,null,{default:t(()=>[e(o,{id:"mermaid-19",class:"mermaid my-class",graph:"flowchart%20LR%0A%20%20%20%20A%5B%22napcat-plugin-debug%3Cbr%2F%3E(NapCat%20%E7%AB%AF%E6%8F%92%E4%BB%B6)%22%5D%20%3C--%3E%7C%22WebSocket%3Cbr%2F%3EJSON-RPC%22%7C%20B%5B%22napcatHmrPlugin%3Cbr%2F%3E(Vite%20%E6%8F%92%E4%BB%B6)%22%5D%0A%0A%20%20%20%20subgraph%20NapCat%20%E7%AB%AF%0A%20%20%20%20%20%20%20%20A%20--%3E%20C%5B%22PluginManager%20API%22%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%0A%20%20%20%20%20%20%20%20V%5B%22Vite%20build%20--watch%22%5D%20--%3E%20B%0A%20%20%20%20%20%20%20%20B%20--%3E%20D%5B%22%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%22%5D%0A%20%20%20%20%20%20%20%20B%20--%3E%20E%5B%22%E8%87%AA%E5%8A%A8%E9%87%8D%E8%BD%BD%22%5D%0A%20%20%20%20end%0A%0A%20%20%20%20style%20A%20fill%3A%23667eea%2Ccolor%3A%23fff%0A%20%20%20%20style%20B%20fill%3A%234CAF50%2Ccolor%3A%23fff%0A%20%20%20%20style%20V%20fill%3A%23bd34fe%2Ccolor%3A%23fff%0A"})]),fallback:t(()=>[...s[6]||(s[6]=[i(" Loading... ",-1)])]),_:1})),a("table",C,[s[12]||(s[12]=a("thead",null,[a("tr",null,[a("th",null,"组件"),a("th",null,"说明")])],-1)),a("tbody",null,[a("tr",null,[a("td",null,[a("strong",null,[e(l,{href:"https://github.com/NapNeko/napcat-plugin-debug",target:"_blank",rel:"noreferrer"},{default:t(()=>[...s[7]||(s[7]=[i("napcat-plugin-debug",-1)])]),_:1})])]),s[8]||(s[8]=a("td",null,[i("NapCat 端插件，启动 WebSocket 服务器（默认 "),a("code",null,"ws://127.0.0.1:8998"),i("），将 PluginManager 的 API 暴露为 JSON-RPC 接口")],-1))]),s[11]||(s[11]=a("tr",null,[a("td",null,[a("strong",null,"napcatHmrPlugin"),i(" (Vite 插件)")]),a("td",null,[i("集成到 Vite 构建流程中，在每次 "),a("code",null,"writeBundle"),i(" 时自动连接调试服务、复制 dist/ 到远程、调用 reloadPlugin。来自 "),a("code",null,"napcat-plugin-debug-cli/vite")])],-1)),a("tr",null,[a("td",null,[a("strong",null,[e(l,{href:"https://www.npmjs.com/package/napcat-plugin-debug-cli",target:"_blank",rel:"noreferrer"},{default:t(()=>[...s[9]||(s[9]=[i("napcat-plugin-debug-cli",-1)])]),_:1})])]),s[10]||(s[10]=a("td",null,"可选的 CLI 工具，提供交互式 REPL、手动部署等功能",-1))])])]),s[23]||(s[23]=p('<h2 id="前置配置" tabindex="-1">前置配置 <a class="header-anchor" href="#前置配置" aria-label="Permalink to &quot;前置配置&quot;">​</a></h2><h3 id="_1-napcat-端-安装调试插件" tabindex="-1">1. NapCat 端：安装调试插件 <a class="header-anchor" href="#_1-napcat-端-安装调试插件" aria-label="Permalink to &quot;1. NapCat 端：安装调试插件&quot;">​</a></h3><p>在 NapCat 的插件市场中搜索并安装 <code>napcat-plugin-debug</code>（插件调试服务），启用后它会自动在 <code>ws://127.0.0.1:8998</code> 启动 WebSocket 调试服务。</p><details class="details custom-block"><summary>调试服务配置项</summary><p>在 NapCat WebUI 的插件配置中可以修改以下参数：</p><table tabindex="0"><thead><tr><th>配置项</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>调试服务端口</td><td><code>8998</code></td><td>WebSocket 监听端口</td></tr><tr><td>监听地址</td><td><code>127.0.0.1</code></td><td>建议仅监听本地地址</td></tr><tr><td>启用认证</td><td><code>false</code></td><td>启用后客户端需提供 token</td></tr><tr><td>认证 Token</td><td>空</td><td>客户端连接时的认证 token</td></tr></tbody></table></details><h3 id="_2-插件项目-安装依赖" tabindex="-1">2. 插件项目：安装依赖 <a class="header-anchor" href="#_2-插件项目-安装依赖" aria-label="Permalink to &quot;2. 插件项目：安装依赖&quot;">​</a></h3><p>在你的插件项目中，安装 <code>napcat-plugin-debug-cli</code> 和 <code>ws</code> 作为开发依赖：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> napcat-plugin-debug-cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ws</span></span></code></pre></div>',7)),a("div",A,[s[16]||(s[16]=a("p",{class:"custom-block-title"},"TIP",-1)),a("p",null,[s[14]||(s[14]=i("如果你使用 ",-1)),e(l,{href:"https://github.com/NapNeko/napcat-plugin-template",target:"_blank",rel:"noreferrer"},{default:t(()=>[...s[13]||(s[13]=[i("napcat-plugin-template",-1)])]),_:1}),s[15]||(s[15]=i(" 模板，这些依赖和配置已经预置好，无需额外操作。",-1))])]),s[24]||(s[24]=p(`<h3 id="_3-配置-vite-插件" tabindex="-1">3. 配置 Vite 插件 <a class="header-anchor" href="#_3-配置-vite-插件" aria-label="Permalink to &quot;3. 配置 Vite 插件&quot;">​</a></h3><p>在 <code>vite.config.ts</code> 中引入并添加 <code>napcatHmrPlugin</code>（模板中已预置）：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { napcatHmrPlugin } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;napcat-plugin-debug-cli/vite&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...其他配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    nodeResolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    copyAssetsPlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    napcatHmrPlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 构建完成后自动部署+重载</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p>可选配置项：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcatHmrPlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  wsUrl: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ws://192.168.1.100:8998&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 调试服务地址（默认 ws://127.0.0.1:8998）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  token: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mySecret&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 认证 token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enabled: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否启用（默认 true）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h3 id="_4-配置-npm-scripts" tabindex="-1">4. 配置 npm scripts <a class="header-anchor" href="#_4-配置-npm-scripts" aria-label="Permalink to &quot;4. 配置 npm scripts&quot;">​</a></h3><p>在 <code>package.json</code> 中添加以下脚本（模板中已预置）：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;scripts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vite build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;push&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vite build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;dev&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vite build --watch&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><table tabindex="0"><thead><tr><th>脚本</th><th>说明</th></tr></thead><tbody><tr><td><code>build</code></td><td>仅构建（如调试服务在线则自动部署）</td></tr><tr><td><code>push</code></td><td>构建 + 自动部署到远程 + 重载插件</td></tr><tr><td><code>dev</code></td><td>持续构建 + 每次构建后自动部署 + 热重载</td></tr></tbody></table><div class="warning custom-block"><p class="custom-block-title">不要使用 <code>deploy</code> 作为脚本名</p><p>pnpm 有内置的 <code>pnpm deploy</code> 命令（用于 workspace 部署），会覆盖 <code>package.json</code> 中的同名脚本，导致 <code>ERR_PNPM_CANNOT_DEPLOY</code> 错误。请使用 <code>push</code> 或其他名称代替。</p></div><blockquote><p>因为 <code>napcatHmrPlugin</code> 已集成到 Vite 构建流程中，所以 <code>push</code> 和 <code>dev</code> 只需要 <code>vite build</code> / <code>vite build --watch</code> 即可，无需额外启动 CLI 进程。</p></blockquote><h2 id="开发流程" tabindex="-1">开发流程 <a class="header-anchor" href="#开发流程" aria-label="Permalink to &quot;开发流程&quot;">​</a></h2><h3 id="一、首次部署" tabindex="-1">一、首次部署 <a class="header-anchor" href="#一、首次部署" aria-label="Permalink to &quot;一、首次部署&quot;">​</a></h3><p>首次开发时，使用 <code>push</code> 命令将插件构建并部署到 NapCat：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span></span></code></pre></div><p>执行 <code>vite build</code> 时，Vite 插件 <code>napcatHmrPlugin</code> 会在构建完成的 <code>writeBundle</code> 钩子中自动执行部署流程：</p>`,16)),(d(),h(r,null,{default:t(()=>[e(o,{id:"mermaid-224",class:"mermaid my-class",graph:"flowchart%20TD%0A%20%20%20%20A%5B%22vite%20build%22%5D%20--%3E%20B%5B%22Vite%20%E6%9E%84%E5%BB%BA%20%E2%86%92%20%E4%BA%A7%E5%87%BA%20dist%2F%22%5D%0A%20%20%20%20B%20--%3E%20C%5B%22napcatHmrPlugin%3A%20writeBundle%20%E9%92%A9%E5%AD%90%22%5D%0A%20%20%20%20C%20--%3E%20D%5B%22%E8%BF%9E%E6%8E%A5%E8%B0%83%E8%AF%95%E6%9C%8D%E5%8A%A1%20WebSocket%22%5D%0A%20%20%20%20D%20--%3E%20E%5B%22RPC%3A%20getDebugInfo()%22%5D%0A%20%20%20%20E%20--%3E%20F%5B%22%E8%8E%B7%E5%8F%96%E8%BF%9C%E7%A8%8B%E6%8F%92%E4%BB%B6%E7%9B%AE%E5%BD%95%E8%B7%AF%E5%BE%84%22%5D%0A%20%20%20%20F%20--%3E%20G%5B%22%E8%AF%BB%E5%8F%96%20dist%2Fpackage.json%20%E7%9A%84%20name%20%E5%AD%97%E6%AE%B5%22%5D%0A%20%20%20%20G%20--%3E%20H%5B%22%E5%A4%8D%E5%88%B6%20dist%2F%20%E2%86%92%20%E8%BF%9C%E7%A8%8B%E6%8F%92%E4%BB%B6%E7%9B%AE%E5%BD%95%2F%E6%8F%92%E4%BB%B6%E5%90%8D%2F%22%5D%0A%20%20%20%20H%20--%3E%20I%7B%22%E6%8F%92%E4%BB%B6%E6%98%AF%E5%90%A6%E5%B7%B2%E6%B3%A8%E5%86%8C%EF%BC%9F%22%7D%0A%20%20%20%20I%20--%20%E6%98%AF%20--%3E%20J%5B%22RPC%3A%20reloadPlugin(id)%22%5D%0A%20%20%20%20I%20--%20%E5%90%A6%20--%3E%20K%5B%22RPC%3A%20loadDirectoryPlugin(path)%22%5D%0A%20%20%20%20J%20--%3E%20L%5B%22%E9%83%A8%E7%BD%B2%E5%AE%8C%E6%88%90%20%E2%9C%93%22%5D%0A%20%20%20%20K%20--%3E%20L%0A%0A%20%20%20%20style%20A%20fill%3A%23e8f4f8%2Cstroke%3A%232196F3%0A%20%20%20%20style%20C%20fill%3A%23bd34fe%2Ccolor%3A%23fff%0A%20%20%20%20style%20L%20fill%3A%23e8f5e9%2Cstroke%3A%234CAF50%0A"})]),fallback:t(()=>[...s[17]||(s[17]=[i(" Loading... ",-1)])]),_:1})),s[25]||(s[25]=p('<h4 id="插件如何知道-napcat-的插件目录" tabindex="-1">插件如何知道 NapCat 的插件目录？ <a class="header-anchor" href="#插件如何知道-napcat-的插件目录" aria-label="Permalink to &quot;插件如何知道 NapCat 的插件目录？&quot;">​</a></h4><p>Vite 插件 <strong>不需要</strong>你手动配置 NapCat 的安装路径。它的工作流程是：</p><ol><li>构建完成后，<code>napcatHmrPlugin</code> 连接 NapCat 端的 <code>napcat-plugin-debug</code> WebSocket 服务（默认 <code>ws://127.0.0.1:8998</code>）</li><li>通过 JSON-RPC 调用 <code>getDebugInfo()</code> 方法，NapCat 返回当前实际的插件目录绝对路径</li><li>读取 <code>dist/package.json</code> 的 <code>name</code> 字段，确定插件名称</li><li>将 <code>dist/</code> 的内容复制到 <code>&lt;远程插件目录&gt;/&lt;插件名&gt;/</code> 下</li><li>调用 <code>reloadPlugin</code> 或 <code>loadDirectoryPlugin</code> 触发热重载</li></ol><p>这意味着无论 NapCat 安装在哪里，Vite 插件都能自动适配。整个流程在一个进程中完成，无需启动额外的 CLI。</p><h3 id="二、持续开发-热重载" tabindex="-1">二、持续开发（热重载） <a class="header-anchor" href="#二、持续开发-热重载" aria-label="Permalink to &quot;二、持续开发（热重载）&quot;">​</a></h3><p>完成首次部署后，使用 <code>dev</code> 命令进入热重载开发模式：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span></span></code></pre></div><p>等价于带 <code>--watch</code> 的 <code>vite build</code>，只需要 <strong>一个进程</strong>：</p><ol><li><strong>Vite watch 模式</strong>：监听 <code>src/</code> 下的源码变更，自动重新构建到 <code>dist/</code></li><li><strong>napcatHmrPlugin</strong>：每次 <code>writeBundle</code>（构建完成）时自动部署到远程并调用热重载</li></ol>',9)),(d(),h(r,null,{default:t(()=>[e(o,{id:"mermaid-283",class:"mermaid my-class",graph:"flowchart%20LR%0A%20%20%20%20A%5B%22%E4%BF%AE%E6%94%B9%E6%BA%90%E7%A0%81%22%5D%20--%3E%20B%5B%22Vite%20watch%3Cbr%2F%3E%E9%87%8D%E6%96%B0%E6%9E%84%E5%BB%BA%20dist%2F%22%5D%0A%20%20%20%20B%20--%3E%20C%5B%22napcatHmrPlugin%3Cbr%2F%3EwriteBundle%20%E9%92%A9%E5%AD%90%22%5D%0A%20%20%20%20C%20--%3E%20D%5B%22WebSocket%3Cbr%2F%3EJSON-RPC%22%5D%0A%20%20%20%20D%20--%3E%20E%5B%22NapCat%3A%3Cbr%2F%3Eplugin_cleanup()%3Cbr%2F%3E%E2%86%93%20%E6%B8%85%E9%99%A4%E6%A8%A1%E5%9D%97%E7%BC%93%E5%AD%98%3Cbr%2F%3E%E2%86%93%20import()%3Cbr%2F%3E%E2%86%93%20plugin_init(ctx)%22%5D%0A%0A%20%20%20%20style%20A%20fill%3A%23fff3e0%2Cstroke%3A%23FF9800%0A%20%20%20%20style%20C%20fill%3A%23bd34fe%2Ccolor%3A%23fff%0A%20%20%20%20style%20E%20fill%3A%23e8f5e9%2Cstroke%3A%234CAF50%0A"})]),fallback:t(()=>[...s[18]||(s[18]=[i(" Loading... ",-1)])]),_:1})),s[26]||(s[26]=p(`<p><strong>改一行代码，保存即生效，无需重启 NapCat。</strong></p><p>NapCat 端在收到重载指令后会：</p><ol><li>调用旧插件实例的 <code>plugin_cleanup()</code> 释放资源</li><li>清除 Node.js 模块缓存</li><li>重新 <code>import()</code> 加载新代码</li><li>调用 <code>plugin_init(ctx)</code> 初始化新实例</li></ol><div class="warning custom-block"><p class="custom-block-title">注意 plugin_cleanup</p><p>热重载依赖 <code>plugin_cleanup</code> 正确释放资源（如定时器、WebSocket 连接、事件监听器等）。如果不清理，可能导致重复注册或内存泄漏。请务必在 <code>plugin_cleanup</code> 中做好清理工作。</p></div><h3 id="三、交互调试-repl" tabindex="-1">三、交互调试（REPL） <a class="header-anchor" href="#三、交互调试-repl" aria-label="Permalink to &quot;三、交互调试（REPL）&quot;">​</a></h3><p>直接运行 CLI 而不带 <code>--watch</code> 或 <code>--deploy</code> 参数，会进入交互式 REPL 模式：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> napcat-debug</span></span></code></pre></div><p>在 REPL 中可以使用以下命令：</p><table tabindex="0"><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>list</code></td><td>列出所有插件及其加载状态</td></tr><tr><td><code>reload &lt;id&gt;</code></td><td>手动重载指定插件</td></tr><tr><td><code>load &lt;id&gt;</code></td><td>加载指定插件</td></tr><tr><td><code>unload &lt;id&gt;</code></td><td>卸载指定插件</td></tr><tr><td><code>info &lt;id&gt;</code></td><td>查看插件详细信息（路径、版本、状态等）</td></tr><tr><td><code>deploy [dir]</code></td><td>部署插件到远程并重载</td></tr><tr><td><code>watch &lt;dir&gt;</code></td><td>启动文件监听</td></tr><tr><td><code>unwatch</code></td><td>停止文件监听</td></tr><tr><td><code>status</code></td><td>查看调试服务状态和 HMR 状态</td></tr><tr><td><code>ping</code></td><td>心跳测试（含延迟）</td></tr><tr><td><code>quit</code></td><td>退出</td></tr></tbody></table><h2 id="cli-完整用法" tabindex="-1">CLI 完整用法 <a class="header-anchor" href="#cli-完整用法" aria-label="Permalink to &quot;CLI 完整用法&quot;">​</a></h2><blockquote><p>CLI 是独立的调试工具，提供 REPL 交互、手动部署等功能。日常开发推荐使用上述 Vite 插件方式（<code>pnpm run dev</code>），无需手动运行 CLI。</p></blockquote><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcat-debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ws-url] [options]</span></span></code></pre></div><table tabindex="0"><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>ws://host:port</code></td><td>调试服务地址（默认 <code>ws://127.0.0.1:8998</code>）</td></tr><tr><td><code>-t, --token &lt;token&gt;</code></td><td>认证 token（当调试服务启用认证时使用）</td></tr><tr><td><code>-w, --watch &lt;dir&gt;</code></td><td>监听指定目录，文件变更时自动热重载</td></tr><tr><td><code>-W, --watch-all</code></td><td>监听远程插件目录下的所有插件</td></tr><tr><td><code>-d, --deploy [dir]</code></td><td>部署插件到远程并重载（默认当前目录）</td></tr><tr><td><code>-v, --verbose</code></td><td>详细输出（显示事件通知等）</td></tr></tbody></table><h3 id="常用组合" tabindex="-1">常用组合 <a class="header-anchor" href="#常用组合" aria-label="Permalink to &quot;常用组合&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 默认连接本地调试服务，进入 REPL</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcat-debug</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 连接远程 NapCat</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcat-debug</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ws://192.168.1.100:8998</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 带认证连接</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcat-debug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --token</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mySecret</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 构建后一键部署</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcat-debug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --deploy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 监听 dist/ 目录自动热重载</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcat-debug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --watch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./dist</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 监听远程所有插件（用于直接编辑远程文件的场景）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">napcat-debug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --watch-all</span></span></code></pre></div><h2 id="完整数据流" tabindex="-1">完整数据流 <a class="header-anchor" href="#完整数据流" aria-label="Permalink to &quot;完整数据流&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>源码修改 (src/)</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>Vite --watch 重新构建 → dist/</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>napcatHmrPlugin writeBundle 钩子</span></span>
<span class="line"><span>  → 复制 dist/ → 远程插件目录/&lt;pluginName&gt;/</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>WebSocket → JSON-RPC reloadPlugin(pluginId)</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>NapCat 端:</span></span>
<span class="line"><span>  1. plugin_cleanup(ctx)     — 卸载旧实例、释放资源</span></span>
<span class="line"><span>  2. 清除 Node.js 模块缓存    — 确保 import() 拿到新代码</span></span>
<span class="line"><span>  3. import(pluginEntry)      — 重新加载插件模块</span></span>
<span class="line"><span>  4. plugin_init(ctx)         — 初始化新实例、注册路由等</span></span></code></pre></div><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h2><h3 id="热重载后插件行为异常" tabindex="-1">热重载后插件行为异常？ <a class="header-anchor" href="#热重载后插件行为异常" aria-label="Permalink to &quot;热重载后插件行为异常？&quot;">​</a></h3><p>检查 <code>plugin_cleanup</code> 是否正确清理了所有资源：</p><ul><li>定时器（<code>clearInterval</code> / <code>clearTimeout</code>）</li><li>WebSocket 连接</li><li>文件监听器</li><li>事件监听器</li></ul><h3 id="连接调试服务失败" tabindex="-1">连接调试服务失败？ <a class="header-anchor" href="#连接调试服务失败" aria-label="Permalink to &quot;连接调试服务失败？&quot;">​</a></h3><ol><li>确认 <code>napcat-plugin-debug</code> 已在 NapCat 中启用</li><li>检查端口是否正确（默认 <code>8998</code>）</li><li>如果启用了认证，确认 token 正确（Vite 插件通过 <code>napcatHmrPlugin({ token: &#39;...&#39; })</code> 配置）</li><li>如果 NapCat 运行在远程机器上，确认防火墙放行了对应端口，且调试服务的监听地址不是 <code>127.0.0.1</code></li></ol><h3 id="部署时提示-dist-不存在" tabindex="-1">部署时提示 <code>dist/</code> 不存在？ <a class="header-anchor" href="#部署时提示-dist-不存在" aria-label="Permalink to &quot;部署时提示 \`dist/\` 不存在？&quot;">​</a></h3><p>先运行 <code>pnpm run build</code> 构建项目，确保 <code>dist/</code> 目录已生成。</p>`,25)),e(k)])}const N=g(E,[["render",F]]);export{P as __pageData,N as default};
